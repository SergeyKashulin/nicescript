<html>
  <head>
    <title>Tic Tac Toe</title>
    <script src="../nice.js"></script>
  </head>
  <body>
<script>
const { Div, H1, OL, LI, Box, Button } = nice;  

const step = Box(0);

const current = Box.by(step, n => n % 2 ? 'o' : 'x');

//TODO: bug: Box([]).length
const state = Box([]).fill(null, 0, 9);

const history = Box([state()]);

const lines = [
  [0, 1, 2],
  [3, 4, 5],
  [6, 7, 8],
  [0, 3, 6],
  [1, 4, 7],
  [2, 5, 8],
  [0, 4, 8],
  [2, 4, 6]
];

const gameOver = Box.by(state, s => 
    lines.some(l => l.map(i => s[i]).every(v => v === current())));

const sellView = (v, i) => Div(v, ' ')
  .textAlign('center').font('3.2rem Arial')
  .width('4rem').height('4rem')
  .border('1px #000 solid')
  .margin('-1px')
  .on('click', () => {
    if(gameOver() || state()[i])
      return;
    state.set(i, current());
    history().length > step + 1 && history.splice(step + 1);
    history.push(state());
    gameOver() || step.inc();
  });

  
const historyButton = (s, i) => 
  LI(Button('Go to move #' + i, () => { state(s); step(i); }));
 
Div(
  Box.by(state, s => Div(s.map(sellView))
      .width('12rem').display('flex').flexWrap('wrap')),
  Box.by(gameOver, o => o ? 'Winner: ' : 'Next player: '), current,  
  Box.by(history, h => OL(h.map(historyButton))),
).margin('1rem').show();
</script>
  </body>
</html>
